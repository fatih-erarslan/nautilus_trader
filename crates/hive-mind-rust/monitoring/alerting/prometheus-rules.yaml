apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hive-mind-alerts
  namespace: hive-mind-production
  labels:
    app: hive-mind-rust
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: hive-mind.critical
    interval: 10s
    rules:
    - alert: HiveMindDown
      expr: up{job="hive-mind-primary"} == 0 or up{job="hive-mind-secondary-1"} == 0 or up{job="hive-mind-secondary-2"} == 0
      for: 1m
      labels:
        severity: critical
        service: hive-mind-rust
        impact: trading-halt
      annotations:
        summary: "Hive Mind instance {{ $labels.instance }} is down"
        description: "Hive Mind service has been down for more than 1 minute. This is a CRITICAL financial trading system failure."
        runbook_url: "https://docs.ximera.trading/runbooks/hive-mind-down"
        
    - alert: TradingLatencyHigh
      expr: histogram_quantile(0.99, rate(trading_operation_duration_seconds_bucket[1m])) > 0.001
      for: 30s
      labels:
        severity: critical
        service: hive-mind-rust
        impact: trading-performance
      annotations:
        summary: "Trading latency is above 1ms (99th percentile)"
        description: "P99 trading latency is {{ $value }}s, above the 1ms SLA. This can result in significant financial losses."
        
    - alert: ConsensusFailure
      expr: increase(consensus_failures_total[5m]) > 5
      for: 1m
      labels:
        severity: critical
        service: hive-mind-rust
        impact: data-consistency
      annotations:
        summary: "Multiple consensus failures detected"
        description: "{{ $value }} consensus failures in the last 5 minutes. System integrity at risk."
        
    - alert: MemoryLeakDetected
      expr: increase(process_resident_memory_bytes[10m]) > 100000000
      for: 5m
      labels:
        severity: critical
        service: hive-mind-rust
        impact: system-stability
      annotations:
        summary: "Potential memory leak detected"
        description: "Memory usage increased by {{ $value }} bytes in 10 minutes. Potential memory leak."
        
    - alert: NetworkPartition
      expr: (
          count(up{job=~"hive-mind.*"} == 1) / 
          count(up{job=~"hive-mind.*"})
        ) < 0.6
      for: 30s
      labels:
        severity: critical
        service: hive-mind-rust
        impact: consensus-breakdown
      annotations:
        summary: "Network partition detected - less than 60% nodes reachable"
        description: "Only {{ $value | humanizePercentage }} of Hive Mind nodes are reachable. Network partition likely."

  - name: hive-mind.warning
    interval: 30s
    rules:
    - alert: HighCPUUsage
      expr: rate(process_cpu_seconds_total[5m]) > 0.8
      for: 3m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: performance
      annotations:
        summary: "High CPU usage detected"
        description: "CPU usage is {{ $value | humanizePercentage }} for more than 3 minutes"
        
    - alert: HighMemoryUsage
      expr: (process_resident_memory_bytes / node_memory_MemTotal_bytes) > 0.85
      for: 2m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: performance
      annotations:
        summary: "High memory usage detected"
        description: "Memory usage is {{ $value | humanizePercentage }} of available memory"
        
    - alert: TradingVolumeAnomaly
      expr: abs(rate(trading_operations_total[5m]) - rate(trading_operations_total[1h] offset 1h)) > 50
      for: 2m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: business-metrics
      annotations:
        summary: "Trading volume anomaly detected"
        description: "Trading volume changed by {{ $value }} ops/sec compared to same time yesterday"
        
    - alert: DiskSpaceLow
      expr: (node_filesystem_avail_bytes{mountpoint="/app/data"} / node_filesystem_size_bytes{mountpoint="/app/data"}) < 0.15
      for: 1m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: storage
      annotations:
        summary: "Low disk space on data volume"
        description: "Only {{ $value | humanizePercentage }} disk space remaining on data volume"
        
    - alert: ErrorRateHigh
      expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.01
      for: 2m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: reliability
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"

  - name: hive-mind.performance
    interval: 1m
    rules:
    - alert: NeuralInferenceDelayed
      expr: histogram_quantile(0.95, rate(neural_inference_duration_seconds_bucket[2m])) > 0.01
      for: 1m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: neural-performance
      annotations:
        summary: "Neural inference taking longer than expected"
        description: "P95 neural inference time is {{ $value }}s, above 10ms threshold"
        
    - alert: DatabaseConnectionPoolExhausted
      expr: database_connections_active / database_connections_max > 0.9
      for: 1m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: database-performance
      annotations:
        summary: "Database connection pool nearly exhausted"
        description: "{{ $value | humanizePercentage }} of database connections are in use"
        
    - alert: GarbageCollectionFrequent
      expr: rate(go_gc_cycles_automatic_gc_cycles_total[5m]) > 5
      for: 2m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: performance
      annotations:
        summary: "Frequent garbage collection cycles detected"
        description: "GC running {{ $value }} times per second, indicating memory pressure"

  - name: hive-mind.business
    interval: 5m
    rules:
    - alert: TradingSystemOffline
      expr: trading_system_health_status != 1
      for: 1m
      labels:
        severity: critical
        service: hive-mind-rust
        impact: business-critical
      annotations:
        summary: "Trading system is offline or unhealthy"
        description: "Trading system health status is {{ $value }}, expected 1 (healthy)"
        
    - alert: ProfitLossAnomaly
      expr: abs(increase(total_pnl_usd[1h]) - avg_over_time(increase(total_pnl_usd[1h])[7d:1h])) > 10000
      for: 1m
      labels:
        severity: warning
        service: hive-mind-rust
        impact: financial-performance
      annotations:
        summary: "P&L deviation from historical average"
        description: "P&L deviates by ${{ $value }} from 7-day average for this hour"
        
    - alert: RiskLimitBreach
      expr: current_position_risk_score > risk_limit_threshold
      for: 30s
      labels:
        severity: critical
        service: hive-mind-rust
        impact: risk-management
      annotations:
        summary: "Risk limit breach detected"
        description: "Current risk score {{ $value }} exceeds limit {{ $labels.risk_limit_threshold }}"