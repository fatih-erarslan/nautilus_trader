name: Production Deployment - Hive Mind Rust Financial System

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_deploy:
        description: 'Force deployment (skip safety checks)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/hive-mind-rust
  KUBE_NAMESPACE: hive-mind-production

jobs:
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build image for scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        target: runtime
        tags: ${{ env.IMAGE_NAME }}:scan
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:scan
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: Docker Scout CVE scan
      uses: docker/scout-action@v1
      if: github.event_name != 'pull_request'
      with:
        command: cves
        image: ${{ env.IMAGE_NAME }}:scan
        exit-code: true
        only-severities: critical,high

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.75.0
        profile: minimal
        override: true
        components: rustfmt, clippy
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Check formatting
      run: cargo fmt -- --check
      
    - name: Lint with Clippy
      run: cargo clippy -- -D warnings
      
    - name: Run unit tests
      run: cargo test --release --all-features
      env:
        RUST_BACKTRACE: 1
        
    - name: Run integration tests
      run: cargo test --release --test integration_tests
      
    - name: Run security tests  
      run: cargo test --release --test security_tests
      
    - name: Performance benchmarks
      run: cargo bench --no-run

  build-image:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      packages: write
      
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix={{branch}}-
          
    - name: Build and push image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        target: runtime
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          RUST_VERSION=1.75
          DEBIAN_VERSION=bullseye
          
    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: spdx-json
        output-file: sbom.spdx.json
        
    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.spdx.json

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.hive-mind.ximera.trading
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}
        
    - name: Deploy to staging
      run: |
        export IMAGE_TAG="${{ github.sha }}"
        export NAMESPACE="hive-mind-staging"
        ./scripts/production/deploy.sh staging
        
    - name: Run staging validation tests
      run: |
        ./scripts/production/validate-deployment.sh staging
        ./scripts/production/performance-test.sh --environment staging
        
    - name: Staging smoke tests
      run: |
        kubectl wait --for=condition=ready pods -l app=hive-mind-rust -n hive-mind-staging --timeout=300s
        kubectl run test-pod --rm -i --image=curlimages/curl:latest -- \
          curl -f http://hive-mind-service:8091/health

  performance-validation:
    name: Performance Validation
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}
        
    - name: Load testing
      run: |
        ./scripts/production/load-test.sh \
          --duration 300 \
          --concurrent-users 1000 \
          --target-latency 1ms
          
    - name: Latency validation
      run: |
        ./scripts/production/latency-validation.sh \
          --p99-threshold 1000 \
          --p95-threshold 500
          
    - name: Memory leak detection
      run: |
        ./scripts/production/memory-leak-test.sh --duration 600
        
    - name: Chaos engineering tests
      run: |
        kubectl create namespace chaos-test || true
        ./scripts/production/chaos-test.sh --namespace hive-mind-staging

  security-validation:
    name: Security Validation
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}
        
    - name: Runtime security scan
      run: |
        kubectl run security-scan --rm -i \
          --image=aquasec/kube-bench:latest \
          --restart=Never -- \
          --targets master,node,controlplane,etcd,policies
          
    - name: Network policy validation
      run: |
        ./scripts/production/network-security-test.sh
        
    - name: Penetration testing
      run: |
        ./scripts/production/pentest.sh --target staging

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-image, performance-validation, security-validation]
    if: (startsWith(github.ref, 'refs/tags/') || github.event.inputs.environment == 'production') && (success() || github.event.inputs.force_deploy == 'true')
    environment:
      name: production
      url: https://hive-mind.ximera.trading
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
        
    - name: Pre-deployment backup
      run: |
        export BACKUP_STORAGE="${{ secrets.BACKUP_STORAGE }}"
        ./scripts/production/disaster-recovery.sh backup
        
    - name: Blue-Green deployment
      run: |
        export IMAGE_TAG="${{ github.sha }}"
        export NAMESPACE="hive-mind-production"
        export WEBHOOK_URL="${{ secrets.DEPLOYMENT_WEBHOOK }}"
        ./scripts/production/deploy.sh blue
        
    - name: Production validation
      run: |
        ./scripts/production/validate-deployment.sh blue
        sleep 30  # Allow metrics to stabilize
        ./scripts/production/trading-functionality-test.sh
        
    - name: Switch traffic
      run: |
        ./scripts/production/deploy.sh switch-traffic blue
        
    - name: Post-deployment monitoring
      run: |
        ./scripts/production/post-deployment-monitor.sh --duration 300
        
    - name: Cleanup old deployment
      run: |
        ./scripts/production/deploy.sh cleanup green

  notify:
    name: Deployment Notifications  
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    
    steps:
    - name: Notify success
      if: needs.deploy-production.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#hive-mind-alerts'
        text: |
          ðŸš€ Hive Mind production deployment successful!
          Version: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        
    - name: Notify failure
      if: needs.deploy-production.result == 'failure'
      uses: 8398a7/action-slack@v3  
      with:
        status: failure
        channel: '#hive-mind-alerts'
        text: |
          ðŸš¨ Hive Mind production deployment FAILED!
          Version: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          Please check logs immediately!
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        
    - name: Create deployment record
      run: |
        curl -X POST "${{ secrets.DEPLOYMENT_API }}" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.DEPLOYMENT_TOKEN }}" \
          -d '{
            "service": "hive-mind-rust",
            "version": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "status": "${{ needs.deploy-production.result }}",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
            "author": "${{ github.actor }}"
          }'

  rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback == 'true'
    environment:
      name: production
      
    steps:
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
        
    - name: Emergency rollback
      run: |
        kubectl rollout undo deployment/hive-mind-rust -n hive-mind-production
        kubectl rollout status deployment/hive-mind-rust -n hive-mind-production --timeout=300s
        
    - name: Verify rollback
      run: |
        kubectl get deployment hive-mind-rust -n hive-mind-production
        kubectl run test-pod --rm -i --image=curlimages/curl:latest -- \
          curl -f http://hive-mind-service:8091/health