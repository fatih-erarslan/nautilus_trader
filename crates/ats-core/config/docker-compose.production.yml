# Production Docker Compose Configuration with Secrets Management
# 
# Security Notice: This configuration uses Docker secrets for production deployment
# DO NOT use environment variables for secrets in production

version: '3.8'

services:
  ats-core:
    image: ats-core:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8081:8081"  # WebSocket port
    environment:
      # Non-sensitive configuration
      - ATS_ENVIRONMENT=production
      - ATS_LOG_LEVEL=warn
      - ATS_DB_HOST=postgres
      - ATS_DB_PORT=5432
      - ATS_DB_NAME=ats_core_production
      - ATS_DB_USER=ats_core_prod
      - ATS_ENCRYPT_AT_REST=true
      - ATS_ENCRYPT_IN_TRANSIT=true
      - ATS_RATE_LIMIT_RPM=100
      - ATS_RATE_LIMIT_BURST=20
      - ATS_MAX_BODY_SIZE=1048576
      - ATS_WORKER_THREADS=4
      - ATS_REQUEST_TIMEOUT_SECONDS=30
      - ATS_SECURITY_AUDIT_ENABLED=true
      - ATS_FAILED_LOGIN_THRESHOLD=5
      
      # Secrets loaded from Docker secrets
      - ATS_JWT_SECRET_FILE=/run/secrets/jwt_secret
      - ATS_ENCRYPTION_KEY_FILE=/run/secrets/encryption_key
      - ATS_DB_PASSWORD_FILE=/run/secrets/db_password
    
    secrets:
      - jwt_secret
      - encryption_key
      - db_password
    
    depends_on:
      - postgres
      - redis
    
    networks:
      - ats-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_DB=ats_core_production
      - POSTGRES_USER=ats_core_prod
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    networks:
      - ats-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ats_core_prod -d ats_core_production"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --requirepass-file /run/secrets/redis_password --appendonly yes
    secrets:
      - redis_password
    volumes:
      - redis_data:/data
    networks:
      - ats-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "$(cat /run/secrets/redis_password)", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - ats-core
    networks:
      - ats-network

secrets:
  jwt_secret:
    external: true
    name: ats_jwt_secret_v1
  encryption_key:
    external: true  
    name: ats_encryption_key_v1
  db_password:
    external: true
    name: ats_db_password_v1
  redis_password:
    external: true
    name: ats_redis_password_v1

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  ats-network:
    driver: bridge