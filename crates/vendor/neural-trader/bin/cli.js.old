#!/usr/bin/env node

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

/**
 * Neural Trader CLI Wrapper
 * Provides fallback strategy for running Rust binary across platforms
 */

function getBinaryPath() {
  const platform = process.platform;
  const arch = process.arch;

  // Map Node.js platform/arch to Rust target triples
  const targetMap = {
    'linux-x64': 'x86_64-unknown-linux-gnu',
    'linux-arm64': 'aarch64-unknown-linux-gnu',
    'darwin-x64': 'x86_64-apple-darwin',
    'darwin-arm64': 'aarch64-apple-darwin',
    'win32-x64': 'x86_64-pc-windows-msvc'
  };

  const target = targetMap[`${platform}-${arch}`];
  if (!target) {
    console.error(`Unsupported platform: ${platform}-${arch}`);
    process.exit(1);
  }

  // Try multiple locations
  const possiblePaths = [
    // Installed via NPM
    path.join(__dirname, '..', 'bin', platform === 'win32' ? 'neural-trader.exe' : 'neural-trader'),
    // Local development
    path.join(__dirname, '..', 'neural-trader-rust', 'target', 'release', platform === 'win32' ? 'neural-trader.exe' : 'neural-trader'),
    // Cargo install
    path.join(process.env.HOME || process.env.USERPROFILE, '.cargo', 'bin', platform === 'win32' ? 'neural-trader.exe' : 'neural-trader')
  ];

  for (const binaryPath of possiblePaths) {
    if (fs.existsSync(binaryPath)) {
      return binaryPath;
    }
  }

  return null;
}

function runWithNativeBinary(binaryPath, args) {
  const child = spawn(binaryPath, args, {
    stdio: 'inherit',
    env: process.env
  });

  child.on('exit', (code, signal) => {
    if (signal) {
      process.kill(process.pid, signal);
    } else {
      process.exit(code || 0);
    }
  });

  process.on('SIGINT', () => child.kill('SIGINT'));
  process.on('SIGTERM', () => child.kill('SIGTERM'));
}

function runWithNapi() {
  try {
    // NAPI bindings don't support CLI mode - they're for the JavaScript API only
    // Check if the module loads to provide a helpful message
    require('../index.js');
    console.error('✓ NAPI bindings available for JavaScript API');
    console.error('✗ CLI mode requires native Rust binary');
    console.error('');
    console.error('To use the CLI:');
    console.error('  1. Install Rust: https://rustup.rs');
    console.error('  2. Build: cd neural-trader-rust && cargo build --release');
    console.error('  3. Run: ./neural-trader-rust/target/release/neural-trader');
    console.error('');
    console.error('Or use the JavaScript API:');
    console.error('  const nt = require("neural-trader");');
    console.error('  nt.fetchMarketData("AAPL", "2024-01-01", "2024-01-31");');
  } catch (error) {
    console.error('NAPI bindings not available:', error.message);
  }
  return false; // Always return false since runCli doesn't exist
}

function showUsageHelp() {
  console.log('');
  console.log('Neural Trader - High-Performance Trading System');
  console.log('');
  console.log('The neural-trader package provides a JavaScript/TypeScript API.');
  console.log('The CLI requires building the native Rust binary separately.');
  console.log('');
  console.log('JavaScript API Usage:');
  console.log('  const nt = require("neural-trader");');
  console.log('');
  console.log('  // Fetch market data');
  console.log('  const data = await nt.fetchMarketData("AAPL", "2024-01-01", "2024-01-31");');
  console.log('');
  console.log('  // Run a strategy');
  console.log('  const result = await nt.runStrategy("momentum", { threshold: 0.02 });');
  console.log('');
  console.log('  // Backtest a strategy');
  console.log('  const backtest = await nt.backtest("momentum", config, "2024-01-01", "2024-12-31");');
  console.log('');
  console.log('For more information: https://github.com/ruvnet/neural-trader');
  process.exit(1);
}

function main() {
  const args = process.argv.slice(2);

  // Strategy 1: Try native Rust binary
  const binaryPath = getBinaryPath();
  if (binaryPath) {
    console.log('✓ Using native Rust binary');
    runWithNativeBinary(binaryPath, args);
    return;
  }

  // Strategy 2: Try NAPI bindings
  console.log('⚠️  Native binary not found, trying NAPI bindings...');
  if (runWithNapi()) {
    return;
  }

  // No CLI available - show usage help
  showUsageHelp();
}

main();
