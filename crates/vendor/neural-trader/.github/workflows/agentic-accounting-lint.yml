name: Agentic Accounting - Code Quality & Linting

on:
  push:
    branches: [main, develop, claude/**]
    paths:
      - 'packages/agentic-accounting/**'
      - 'neural-trader-rust/crates/agentic-accounting/**'
      - '.github/workflows/agentic-accounting-lint.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/agentic-accounting/**'
      - 'neural-trader-rust/crates/agentic-accounting/**'

env:
  NODE_VERSION: '18'
  RUST_VERSION: 'stable'

jobs:
  # ESLint for TypeScript
  eslint:
    name: ESLint (TypeScript)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          npx eslint "packages/agentic-accounting/**/*.{ts,tsx,js,jsx}" \
            --format stylish \
            --max-warnings 0 \
            --cache \
            --cache-location .eslintcache
        continue-on-error: false

      - name: Upload ESLint report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 7

  # Prettier formatting check
  prettier:
    name: Prettier (Format Check)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: |
          npx prettier --check "packages/agentic-accounting/**/*.{ts,tsx,js,jsx,json,md}" \
            --ignore-path .prettierignore

      - name: Generate formatting report
        if: failure()
        run: |
          echo "## Formatting Issues Found" > formatting-report.md
          npx prettier --check "packages/agentic-accounting/**/*.{ts,tsx,js,jsx,json,md}" \
            --ignore-path .prettierignore >> formatting-report.md || true
          cat formatting-report.md >> $GITHUB_STEP_SUMMARY

  # TypeScript type checking
  typescript:
    name: TypeScript (Type Check)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: |
          cd packages/agentic-accounting
          npx tsc --noEmit --pretty

  # Rust formatting with cargo fmt
  rust-fmt:
    name: Rust Format (cargo fmt)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          profile: minimal
          override: true
          components: rustfmt

      - name: Check Rust formatting
        run: |
          cd neural-trader-rust
          cargo fmt --all -- --check
        continue-on-error: false

      - name: Generate formatting diff
        if: failure()
        run: |
          cd neural-trader-rust
          cargo fmt --all -- --check --verbose > formatting-diff.txt || true
          echo "## Rust Formatting Issues" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat formatting-diff.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Rust linting with cargo clippy
  rust-clippy:
    name: Rust Lint (cargo clippy)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          profile: minimal
          override: true
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            neural-trader-rust/target
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy
        run: |
          cd neural-trader-rust
          cargo clippy --workspace --all-targets --all-features -- \
            -D warnings \
            -W clippy::all \
            -W clippy::pedantic \
            -W clippy::nursery \
            -A clippy::module_name_repetitions \
            -A clippy::missing_errors_doc \
            -A clippy::missing_panics_doc

      - name: Upload Clippy results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: clippy-results
          path: clippy-results.json
          retention-days: 7

  # Security audit for dependencies
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          profile: minimal
          override: true

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Install cargo-audit
        run: cargo install cargo-audit || true

      - name: Run cargo audit
        run: |
          cd neural-trader-rust
          cargo audit --deny warnings
        continue-on-error: true

  # Code complexity analysis
  complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run complexity analysis
        run: |
          npx ts-complex packages/agentic-accounting/src/**/*.ts \
            --threshold 15 \
            --format json \
            --output complexity-report.json || true

      - name: Upload complexity report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: complexity-report
          path: complexity-report.json
          retention-days: 30

  # Quality gate summary
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [eslint, prettier, typescript, rust-fmt, rust-clippy, security-audit]
    if: always()

    steps:
      - name: Check quality gate
        run: |
          echo "### Code Quality Summary :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.eslint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | ${{ needs.prettier.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Format | ${{ needs.rust-fmt.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Clippy | ${{ needs.rust-clippy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.eslint.result }}" == "failure" ]] || \
             [[ "${{ needs.prettier.result }}" == "failure" ]] || \
             [[ "${{ needs.typescript.result }}" == "failure" ]] || \
             [[ "${{ needs.rust-fmt.result }}" == "failure" ]] || \
             [[ "${{ needs.rust-clippy.result }}" == "failure" ]]; then
            echo "::error::Quality gate failed - please fix the issues above"
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All quality checks passed! :rocket:" >> $GITHUB_STEP_SUMMARY
