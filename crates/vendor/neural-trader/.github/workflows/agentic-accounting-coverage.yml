name: Agentic Accounting - Code Coverage

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/agentic-accounting/**'
      - 'neural-trader-rust/crates/agentic-accounting/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/agentic-accounting/**'
      - 'neural-trader-rust/crates/agentic-accounting/**'
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

env:
  NODE_VERSION: '18'
  RUST_VERSION: 'stable'
  COVERAGE_THRESHOLD: 90

jobs:
  # Generate comprehensive coverage report
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: coverage_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for accurate coverage

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          profile: minimal
          override: true
          components: llvm-tools-preview

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cargo/registry
            ~/.cargo/git
            neural-trader-rust/target
          key: ${{ runner.os }}-coverage-${{ hashFiles('**/package-lock.json', '**/Cargo.lock') }}

      - name: Install dependencies
        run: npm ci

      - name: Setup test database
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d coverage_test -c "CREATE EXTENSION IF NOT EXISTS vector;"
        env:
          PGPASSWORD: postgres

      - name: Run TypeScript tests with coverage
        run: |
          npm run test -- \
            --coverage \
            --coverageDirectory=./coverage \
            --coverageReporters=json,lcov,text,html \
            --collectCoverageFrom="packages/agentic-accounting/**/*.{ts,tsx}" \
            --coveragePathIgnorePatterns="/node_modules/|/dist/|/test/" \
            --maxWorkers=2
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/coverage_test
          REDIS_URL: redis://localhost:6379

      - name: Check TypeScript coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "TypeScript Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::TypeScript coverage ($COVERAGE%) is below threshold ($COVERAGE_THRESHOLD%)"
            exit 1
          fi

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin || true

      - name: Run Rust tests with coverage
        run: |
          cd neural-trader-rust
          cargo tarpaulin \
            --workspace \
            --engine llvm \
            --out Xml \
            --out Html \
            --output-dir ../coverage-rust \
            --timeout 300 \
            --exclude-files "*/tests/*" "*/benches/*" \
            --ignore-panics \
            --verbose
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info,./coverage-rust/cobertura.xml
          flags: agentic-accounting
          name: agentic-accounting-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          verbose: true

      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          badges-directory: badges
          generate-branches-badge: true
          generate-summary: true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage/
            coverage-rust/
            badges/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

      - name: Generate coverage summary
        run: |
          echo "### Coverage Report :bar_chart:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### TypeScript Coverage" >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.json | jq -r '
            .total |
            "| Metric | Coverage | Status |\n|--------|----------|--------|\n" +
            "| Lines | \(.lines.pct)% | \(if .lines.pct >= 90 then ":white_check_mark:" else ":warning:" end) |\n" +
            "| Statements | \(.statements.pct)% | \(if .statements.pct >= 90 then ":white_check_mark:" else ":warning:" end) |\n" +
            "| Functions | \(.functions.pct)% | \(if .functions.pct >= 90 then ":white_check_mark:" else ":warning:" end) |\n" +
            "| Branches | \(.branches.pct)% | \(if .branches.pct >= 90 then ":white_check_mark:" else ":warning:" end) |"
          ' >> $GITHUB_STEP_SUMMARY

  # Coverage trend analysis
  coverage-trend:
    name: Coverage Trend Analysis
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: coverage/

      - name: Store coverage history
        run: |
          mkdir -p coverage-history
          DATE=$(date +%Y-%m-%d)
          cp coverage/coverage-summary.json "coverage-history/coverage-$DATE.json"

      - name: Commit coverage history
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage-history/
          git commit -m "chore: update coverage history for $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push || echo "Nothing to push"
        continue-on-error: true

  # Coverage quality gate
  coverage-gate:
    name: Coverage Quality Gate
    runs-on: ubuntu-latest
    needs: coverage
    if: always()

    steps:
      - name: Check coverage gate
        run: |
          if [[ "${{ needs.coverage.result }}" == "failure" ]]; then
            echo "::error::Coverage quality gate failed"
            echo "Coverage is below the required threshold of ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          fi

          echo "### Coverage Quality Gate :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage meets the required threshold of ${{ env.COVERAGE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
