name: Build Multi-Platform Binaries

on:
  push:
    tags:
      - 'v2.2.*'
      - 'v2.3.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.2.0)'
        required: true
        default: '2.2.0'
      platforms:
        description: 'Platforms to build (comma-separated: windows,macos-intel,macos-arm,linux-arm)'
        required: true
        default: 'windows,macos-intel,macos-arm'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Build Windows x64 binary
    runs-on: windows-latest
    if: contains(github.event.inputs.platforms, 'windows') || startsWith(github.ref, 'refs/tags/v2.2')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-pc-windows-msvc

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install NAPI-RS CLI
        run: npm install -g @napi-rs/cli

      - name: Build Windows binary
        working-directory: neural-trader-rust/crates/napi-bindings
        run: |
          cargo build --release --target x86_64-pc-windows-msvc

      - name: Copy Windows binary to packages
        working-directory: neural-trader-rust
        shell: bash
        run: |
          BINARY_PATH="target/x86_64-pc-windows-msvc/release/nt_napi_bindings.dll"

          for pkg in packages/{backtesting,brokers,execution,features,market-data,neural,news-trading,portfolio,prediction-markets,risk,sports-betting,strategies}/native; do
            mkdir -p "$pkg"
            cp "$BINARY_PATH" "$pkg/neural-trader.win32-x64-msvc.node"
          done

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: neural-trader-rust/packages/*/native/*.win32-x64-msvc.node

  build-macos-intel:
    name: Build macOS Intel (x86_64) binary
    runs-on: macos-13  # Intel runner
    if: contains(github.event.inputs.platforms, 'macos-intel') || startsWith(github.ref, 'refs/tags/v2.2')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build macOS Intel binary
        working-directory: neural-trader-rust/crates/napi-bindings
        run: |
          cargo build --release --target x86_64-apple-darwin

      - name: Copy macOS Intel binary to packages
        working-directory: neural-trader-rust
        run: |
          BINARY_PATH="target/x86_64-apple-darwin/release/libnt_napi_bindings.dylib"

          for pkg in packages/{backtesting,brokers,execution,features,market-data,neural,news-trading,portfolio,prediction-markets,risk,sports-betting,strategies}/native; do
            mkdir -p "$pkg"
            cp "$BINARY_PATH" "$pkg/neural-trader.darwin-x64.node"
            chmod +x "$pkg/neural-trader.darwin-x64.node"
          done

      - name: Upload macOS Intel binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-binaries
          path: neural-trader-rust/packages/*/native/*.darwin-x64.node

  build-macos-arm:
    name: Build macOS Apple Silicon (ARM64) binary
    runs-on: macos-14  # M1 runner
    if: contains(github.event.inputs.platforms, 'macos-arm') || startsWith(github.ref, 'refs/tags/v2.2')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build macOS ARM binary
        working-directory: neural-trader-rust/crates/napi-bindings
        run: |
          cargo build --release --target aarch64-apple-darwin

      - name: Copy macOS ARM binary to packages
        working-directory: neural-trader-rust
        run: |
          BINARY_PATH="target/aarch64-apple-darwin/release/libnt_napi_bindings.dylib"

          for pkg in packages/{backtesting,brokers,execution,features,market-data,neural,news-trading,portfolio,prediction-markets,risk,sports-betting,strategies}/native; do
            mkdir -p "$pkg"
            cp "$BINARY_PATH" "$pkg/neural-trader.darwin-arm64.node"
            chmod +x "$pkg/neural-trader.darwin-arm64.node"
          done

      - name: Upload macOS ARM binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-binaries
          path: neural-trader-rust/packages/*/native/*.darwin-arm64.node

  build-linux-arm:
    name: Build Linux ARM64 binary
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.platforms, 'linux-arm') || startsWith(github.ref, 'refs/tags/v2.3')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-unknown-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build Linux ARM64 binary
        working-directory: neural-trader-rust/crates/napi-bindings
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu

      - name: Copy Linux ARM64 binary to packages
        working-directory: neural-trader-rust
        run: |
          BINARY_PATH="target/aarch64-unknown-linux-gnu/release/libnt_napi_bindings.so"

          for pkg in packages/{backtesting,brokers,execution,features,market-data,neural,news-trading,portfolio,prediction-markets,risk,sports-betting,strategies}/native; do
            mkdir -p "$pkg"
            cp "$BINARY_PATH" "$pkg/neural-trader.linux-arm64-gnu.node"
            chmod +x "$pkg/neural-trader.linux-arm64-gnu.node"
          done

      - name: Upload Linux ARM64 binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm-binaries
          path: neural-trader-rust/packages/*/native/*.linux-arm64-gnu.node

  publish-multi-platform:
    name: Publish multi-platform packages
    needs: [build-windows, build-macos-intel, build-macos-arm, build-linux-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all platform binaries
        uses: actions/download-artifact@v4
        with:
          path: neural-trader-rust/packages

      - name: Reorganize binaries
        working-directory: neural-trader-rust/packages
        run: |
          # Move binaries from artifact directories to native/ dirs
          for artifact_dir in windows-binaries macos-intel-binaries macos-arm-binaries linux-arm-binaries; do
            if [ -d "$artifact_dir" ]; then
              find "$artifact_dir" -name "*.node" -exec sh -c '
                for file; do
                  pkg=$(echo "$file" | cut -d/ -f2)
                  mkdir -p "$pkg/native"
                  cp "$file" "$pkg/native/"
                done
              ' sh {} +
              rm -rf "$artifact_dir"
            fi
          done

      - name: Update package versions
        working-directory: neural-trader-rust/packages
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"

          for pkg in backtesting brokers execution features market-data neural news-trading portfolio prediction-markets risk sports-betting strategies; do
            cd $pkg
            npm version $VERSION --no-git-tag-version
            cd ..
          done

      - name: Verify multi-platform binaries
        working-directory: neural-trader-rust/packages
        run: |
          echo "ðŸ“¦ Verifying binaries in packages..."
          for pkg in backtesting brokers execution features market-data neural news-trading portfolio prediction-markets risk sports-betting strategies; do
            echo "Checking $pkg/native/:"
            ls -lh $pkg/native/
          done

      - name: Publish packages to npm
        working-directory: neural-trader-rust/packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg in backtesting brokers execution features market-data neural news-trading portfolio prediction-markets risk sports-betting strategies; do
            echo "ðŸ“¦ Publishing @neural-trader/$pkg..."
            cd $pkg
            npm publish --access public
            cd ..
            sleep 3
          done

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Neural Trader ${{ github.ref_name }}
          body: |
            ## Neural Trader ${{ github.ref_name }} - Multi-Platform Release

            ### âœ¨ Platform Support
            - âœ… Linux x86_64 (glibc)
            - âœ… Linux x86_64 (musl) - Alpine Linux
            - âœ… Windows x86_64 (MSVC)
            - âœ… macOS x86_64 (Intel)
            - âœ… macOS ARM64 (Apple Silicon M1/M2/M3)

            ### ðŸ“¦ Binary Files
            Each package now includes native binaries for all platforms:
            - `neural-trader.linux-x64-gnu.node` (Linux glibc)
            - `neural-trader.linux-x64-musl.node` (Alpine Linux)
            - `neural-trader.win32-x64-msvc.node` (Windows)
            - `neural-trader.darwin-x64.node` (macOS Intel)
            - `neural-trader.darwin-arm64.node` (macOS Apple Silicon)

            ### ðŸŽ‰ Universal Compatibility
            Neural Trader now works on all major platforms out of the box!
          draft: false
          prerelease: false
