# Quality Gates Enforcement
# This workflow enforces strict quality standards on all PRs
# Failures here will block merging to main branch

name: Quality Gates

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # Performance targets (in CI, targets are relaxed by 20% to account for noisy runners)
  MAX_MARKET_DATA_LATENCY_US: 120    # Target: 100Î¼s, CI: 120Î¼s
  MAX_FEATURE_EXTRACT_LATENCY_MS: 1.2  # Target: 1ms, CI: 1.2ms
  MAX_SIGNAL_GEN_LATENCY_MS: 6.0       # Target: 5ms, CI: 6ms
  MIN_COVERAGE_PERCENT: 90.0

jobs:
  # ============================================================================
  # GATE 1: Code Quality
  # ============================================================================
  code-quality:
    name: "Gate 1: Code Quality"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: |
          cargo fmt --all -- --check
          if [ $? -ne 0 ]; then
            echo "âŒ Code formatting check failed"
            echo "Run: cargo fmt --all"
            exit 1
          fi
          echo "âœ… Code formatting passed"

      - name: Clippy lints (zero warnings)
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
          if [ $? -ne 0 ]; then
            echo "âŒ Clippy found issues"
            echo "Run: cargo clippy --all-targets --all-features --fix"
            exit 1
          fi
          echo "âœ… Clippy passed with zero warnings"

      - name: Check documentation
        run: |
          cargo doc --no-deps --all-features --document-private-items 2>&1 | tee doc_output.txt
          if grep -q "warning:" doc_output.txt; then
            echo "âŒ Documentation warnings found"
            cat doc_output.txt
            exit 1
          fi
          echo "âœ… Documentation complete and accurate"

  # ============================================================================
  # GATE 2: Test Coverage
  # ============================================================================
  test-coverage:
    name: "Gate 2: Test Coverage (â‰¥90%)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        run: |
          cargo tarpaulin --out Xml --output-dir coverage \
            --exclude-files 'tests/*' 'benches/*' 'examples/*' \
            --ignore-panics --ignore-tests --timeout 300

      - name: Check coverage threshold
        run: |
          COVERAGE=$(cargo tarpaulin --output-dir /tmp 2>&1 | grep -oP '\d+\.\d+(?=%)' | head -1)
          echo "Coverage: $COVERAGE%"
          echo "Threshold: $MIN_COVERAGE_PERCENT%"

          if (( $(echo "$COVERAGE < $MIN_COVERAGE_PERCENT" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below $MIN_COVERAGE_PERCENT% threshold"
            echo "Add more tests to increase coverage"
            exit 1
          fi
          echo "âœ… Coverage $COVERAGE% meets threshold"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/cobertura.xml
          fail_ci_if_error: false

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('/tmp/tarpaulin-report.txt', 'utf8');
            const match = coverage.match(/(\d+\.\d+)%/);
            const coveragePercent = match ? match[1] : 'unknown';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ðŸ“Š Test Coverage Report\n\n**Coverage: ${coveragePercent}%**\n\n${coveragePercent >= 90 ? 'âœ…' : 'âŒ'} Threshold: 90%`
            });

  # ============================================================================
  # GATE 3: Security Audit
  # ============================================================================
  security-audit:
    name: "Gate 3: Security Audit"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: |
          cargo audit --deny warnings 2>&1 | tee audit_output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ Security vulnerabilities found"
            cat audit_output.txt
            echo ""
            echo "Fix vulnerabilities by updating dependencies:"
            echo "  cargo update"
            exit 1
          fi
          echo "âœ… No security vulnerabilities found"

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Check licenses
        run: |
          cargo deny check licenses
          if [ $? -ne 0 ]; then
            echo "âŒ License violations found"
            exit 1
          fi
          echo "âœ… All licenses approved"

      - name: Check for banned dependencies
        run: |
          cargo deny check bans
          if [ $? -ne 0 ]; then
            echo "âŒ Banned dependencies found"
            exit 1
          fi
          echo "âœ… No banned dependencies"

  # ============================================================================
  # GATE 4: All Tests Pass
  # ============================================================================
  tests:
    name: "Gate 4: Test Suite"
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Run unit tests
        run: |
          cargo test --lib --bins --verbose
          if [ $? -ne 0 ]; then
            echo "âŒ Unit tests failed on ${{ matrix.os }}"
            exit 1
          fi
          echo "âœ… Unit tests passed"

      - name: Run integration tests
        run: |
          cargo test --test '*' --verbose
          if [ $? -ne 0 ]; then
            echo "âŒ Integration tests failed on ${{ matrix.os }}"
            exit 1
          fi
          echo "âœ… Integration tests passed"

      - name: Run doc tests
        run: |
          cargo test --doc --verbose
          if [ $? -ne 0 ]; then
            echo "âŒ Documentation tests failed on ${{ matrix.os }}"
            exit 1
          fi
          echo "âœ… Documentation tests passed"

  # ============================================================================
  # GATE 5: Performance Benchmarks
  # ============================================================================
  performance:
    name: "Gate 5: Performance Benchmarks"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for baseline comparison

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache criterion baselines
        uses: actions/cache@v3
        with:
          path: target/criterion
          key: criterion-baseline-${{ github.base_ref }}

      - name: Run benchmarks
        run: |
          cargo bench --no-fail-fast -- --save-baseline pr-benchmark

      - name: Compare with baseline
        if: github.base_ref != ''
        run: |
          # Compare with main branch baseline
          cargo bench -- --baseline ${{ github.base_ref }} --load-baseline pr-benchmark > bench_comparison.txt || true
          cat bench_comparison.txt

      - name: Validate performance targets
        run: |
          # Parse benchmark results and check against targets
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          # Load benchmark results
          results_dir = Path("target/criterion")

          failures = []

          # Check market data ingestion latency
          market_data_result = results_dir / "market_data_ingestion" / "new" / "estimates.json"
          if market_data_result.exists():
              with open(market_data_result) as f:
                  data = json.load(f)
                  mean_ns = data["mean"]["point_estimate"]
                  mean_us = mean_ns / 1000.0
                  target_us = float("${{ env.MAX_MARKET_DATA_LATENCY_US }}")

                  if mean_us > target_us:
                      failures.append(f"Market data latency: {mean_us:.2f}Î¼s > {target_us}Î¼s target")
                  else:
                      print(f"âœ… Market data latency: {mean_us:.2f}Î¼s <= {target_us}Î¼s")

          if failures:
              print("\nâŒ Performance targets not met:")
              for failure in failures:
                  print(f"  - {failure}")
              sys.exit(1)
          else:
              print("\nâœ… All performance targets met")
          EOF

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: target/criterion/

  # ============================================================================
  # GATE 6: Parity Tests
  # ============================================================================
  parity:
    name: "Gate 6: Python Parity"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          if [ -f python_impl/requirements.txt ]; then
            pip install -r python_impl/requirements.txt
          fi

      - name: Run parity tests
        run: |
          cargo test --test parity -- --ignored --nocapture
          if [ $? -ne 0 ]; then
            echo "âŒ Parity tests failed - Rust implementation differs from Python"
            echo "Review parity test output for differences"
            exit 1
          fi
          echo "âœ… Parity tests passed - Rust matches Python behavior"

  # ============================================================================
  # GATE 7: MCP Compliance
  # ============================================================================
  mcp-compliance:
    name: "Gate 7: MCP Compliance"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build MCP server
        run: |
          cargo build --release --features mcp-server

      - name: Install MCP validator
        run: |
          npm install -g @modelcontextprotocol/validator || true
          # Fallback if validator not available
          echo "MCP validator installation attempted"

      - name: Validate MCP implementation
        run: |
          # Run MCP-specific tests
          cargo test --features mcp-integration --verbose
          if [ $? -ne 0 ]; then
            echo "âŒ MCP integration tests failed"
            exit 1
          fi
          echo "âœ… MCP compliance verified"

  # ============================================================================
  # GATE 8: Build Validation
  # ============================================================================
  build-validation:
    name: "Gate 8: Build Matrix"
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: |
          cargo build --release --target ${{ matrix.target }} --verbose
          if [ $? -ne 0 ]; then
            echo "âŒ Release build failed for ${{ matrix.target }}"
            exit 1
          fi
          echo "âœ… Release build succeeded for ${{ matrix.target }}"

      - name: Test release binary
        run: |
          cargo test --release --target ${{ matrix.target }}
          if [ $? -ne 0 ]; then
            echo "âŒ Release tests failed for ${{ matrix.target }}"
            exit 1
          fi
          echo "âœ… Release tests passed for ${{ matrix.target }}"

  # ============================================================================
  # FINAL GATE: Summary Report
  # ============================================================================
  quality-gate-summary:
    name: "Quality Gate Summary"
    needs:
      [
        code-quality,
        test-coverage,
        security-audit,
        tests,
        performance,
        parity,
        mcp-compliance,
        build-validation,
      ]
    runs-on: ubuntu-latest
    steps:
      - name: All quality gates passed
        run: |
          echo "================================================"
          echo "ðŸŽ‰ ALL QUALITY GATES PASSED ðŸŽ‰"
          echo "================================================"
          echo ""
          echo "âœ… Gate 1: Code Quality"
          echo "âœ… Gate 2: Test Coverage (â‰¥90%)"
          echo "âœ… Gate 3: Security Audit"
          echo "âœ… Gate 4: Test Suite (All Platforms)"
          echo "âœ… Gate 5: Performance Benchmarks"
          echo "âœ… Gate 6: Python Parity"
          echo "âœ… Gate 7: MCP Compliance"
          echo "âœ… Gate 8: Build Matrix"
          echo ""
          echo "This PR is ready to merge! ðŸš€"
          echo "================================================"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸŽ‰ All Quality Gates Passed!\n\nâœ… Code Quality\nâœ… Test Coverage (â‰¥90%)\nâœ… Security Audit\nâœ… Test Suite\nâœ… Performance Benchmarks\nâœ… Python Parity\nâœ… MCP Compliance\nâœ… Build Matrix\n\n**This PR is ready to merge! ðŸš€**`
            });
