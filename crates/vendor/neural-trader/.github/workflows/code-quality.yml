name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIRECTORY: './trading-platform/symbolic_trading'

jobs:
  # Dependency scanning and vulnerability assessment
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install scanning tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep detect-secrets
        
    - name: Dependency vulnerability scan
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        safety check --json --output safety-report.json --continue-on-error
        
    - name: Static security analysis
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        bandit -r src/ -f json -o bandit-report.json
        
    - name: Secret detection
      run: |
        detect-secrets scan --all-files --baseline .secrets.baseline
        
    - name: Advanced security scanning
      run: |
        semgrep --config=auto src/ --json --output=semgrep-report.json || true
        
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          ${{ env.WORKING_DIRECTORY }}/safety-report.json
          ${{ env.WORKING_DIRECTORY }}/bandit-report.json
          semgrep-report.json

  # Code quality metrics
  code-metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon mccabe
        
    - name: Calculate code complexity
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # Cyclomatic complexity
        radon cc src/ --json > complexity-report.json
        
        # Maintainability index
        radon mi src/ --json > maintainability-report.json
        
        # Raw metrics (LOC, LLOC, SLOC)
        radon raw src/ --json > raw-metrics.json
        
        # Halstead metrics
        radon hal src/ --json > halstead-report.json
        
    - name: Check complexity thresholds
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # Fail if cyclomatic complexity is too high
        xenon --max-absolute B --max-modules A --max-average A src/
        
    - name: Upload quality reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-quality-reports
        path: |
          ${{ env.WORKING_DIRECTORY }}/complexity-report.json
          ${{ env.WORKING_DIRECTORY }}/maintainability-report.json
          ${{ env.WORKING_DIRECTORY }}/raw-metrics.json
          ${{ env.WORKING_DIRECTORY }}/halstead-report.json

  # Documentation and API validation
  docs-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install documentation tools
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pydocstyle darglint
        
    - name: Check docstring coverage
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        pydocstyle src/ --count --explain --source
        
    - name: Validate docstring arguments
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        darglint src/ -v 2
        
    - name: Generate API documentation
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # This would generate API docs using Sphinx
        echo "API documentation generation would happen here"

  # Test quality assessment
  test-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-testmon pytest-picked
        
    - name: Analyze test coverage
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # Run tests with detailed coverage
        pytest tests/ \
          --cov=src \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-branch \
          --cov-fail-under=80
          
    - name: Test mutation testing
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # Install and run mutmut for mutation testing
        pip install mutmut
        mutmut run --paths-to-mutate=src/ --tests-dir=tests/ --runner="python -m pytest" || true
        mutmut junitxml > mutation-test-results.xml
        
    - name: Upload test quality reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-quality-reports
        path: |
          ${{ env.WORKING_DIRECTORY }}/htmlcov/
          ${{ env.WORKING_DIRECTORY }}/mutation-test-results.xml

  # License and compliance checking
  compliance:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install compliance tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-licenses licensecheck
        
    - name: Check dependency licenses
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        pip install -r requirements.txt
        pip-licenses --format=json --output-file=license-report.json
        
    - name: Validate license compatibility
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # Check for incompatible licenses
        pip-licenses --fail-on="GPL v3;AGPL v3"
        
    - name: Upload compliance reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: compliance-reports
        path: |
          ${{ env.WORKING_DIRECTORY }}/license-report.json

  # Performance profiling
  performance-profile:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install profiling tools
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install py-spy memory-profiler line-profiler
        
    - name: Run performance profiling
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        # Memory profiling
        python -m memory_profiler tests/test_performance.py > memory-profile.txt || true
        
        # CPU profiling with py-spy would require a running process
        echo "CPU profiling would be done on running services"
        
    - name: Upload profiling reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-profiles
        path: |
          ${{ env.WORKING_DIRECTORY }}/memory-profile.txt

  # Quality gate summary
  quality-summary:
    runs-on: ubuntu-latest
    needs: [security-scan, code-metrics, docs-validation, test-quality, compliance]
    if: always()
    
    steps:
    - name: Download all quality artifacts
      uses: actions/download-artifact@v3
      
    - name: Generate quality report
      run: |
        echo "## Code Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Security
        if [ -f "security-reports/safety-report.json" ]; then
          VULN_COUNT=$(jq '.vulnerabilities | length' security-reports/safety-report.json 2>/dev/null || echo "0")
          echo "- **Security**: $VULN_COUNT vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Complexity
        if [ -f "code-quality-reports/complexity-report.json" ]; then
          echo "- **Code Complexity**: Reports generated" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Test Quality
        if [ -f "test-quality-reports/htmlcov/index.html" ]; then
          echo "- **Test Coverage**: Report available" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Compliance
        if [ -f "compliance-reports/license-report.json" ]; then
          echo "- **License Compliance**: Checked" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All quality checks completed!" >> $GITHUB_STEP_SUMMARY
        
    - name: Set quality gates
      run: |
        # Define quality gates
        QUALITY_PASSED=true
        
        # Check security vulnerabilities
        if [ -f "security-reports/safety-report.json" ]; then
          VULN_COUNT=$(jq '.vulnerabilities | length' security-reports/safety-report.json 2>/dev/null || echo "0")
          if [ "$VULN_COUNT" -gt "0" ]; then
            echo "❌ Security gate failed: $VULN_COUNT vulnerabilities found"
            QUALITY_PASSED=false
          fi
        fi
        
        if [ "$QUALITY_PASSED" = true ]; then
          echo "✅ All quality gates passed!"
        else
          echo "❌ Quality gates failed!"
          exit 1
        fi
