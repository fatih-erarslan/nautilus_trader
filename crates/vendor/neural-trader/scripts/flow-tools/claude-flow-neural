#!/usr/bin/env python3
"""
Enhanced Claude-Flow CLI with Neural Forecasting Extensions
Main entry point for all Claude-Flow commands including neural forecasting.
"""

import sys
import os
import click
from pathlib import Path
from typing import Optional

# Ensure proper path setup
SCRIPT_DIR = Path(__file__).parent.absolute()
sys.path.insert(0, str(SCRIPT_DIR))
sys.path.insert(0, str(SCRIPT_DIR / "benchmark"))

# Set working directory context
os.environ['CLAUDE_WORKING_DIR'] = str(SCRIPT_DIR)

# Import version info
try:
    __version__ = "1.0.0-neural"
except ImportError:
    __version__ = "1.0.0"


@click.group(invoke_without_command=True)
@click.option('--version', is_flag=True, help='Show version information')
@click.pass_context
def cli(ctx, version):
    """
    Claude-Flow: Advanced AI Trading Platform CLI
    
    Enhanced with Neural Forecasting capabilities for next-generation trading strategies.
    
    Available command groups:
    - neural: Neural forecasting commands
    - benchmark: Performance benchmarking
    - simulate: Trading simulations  
    - optimize: Strategy optimization
    - report: Performance reporting
    
    Examples:
        claude-flow neural forecast AAPL --horizon 24 --gpu
        claude-flow neural train data.csv --model nhits --epochs 200
        claude-flow benchmark --strategy all --duration 1h
    """
    if version:
        click.echo(f"Claude-Flow Neural Edition v{__version__}")
        click.echo("Enhanced with Neural Forecasting capabilities")
        return
    
    if ctx.invoked_subcommand is None:
        click.echo(ctx.get_help())


@cli.group()
def neural():
    """Neural forecasting commands for AI trading."""
    pass


@neural.command()
@click.argument('symbol', required=True)
@click.option('--horizon', '-h', type=int, default=24, 
              help='Forecast horizon in hours (default: 24)')
@click.option('--model', '-m', 
              type=click.Choice(['nhits', 'nbeats', 'tft', 'patchtst', 'auto']),
              default='auto',
              help='Neural model to use for forecasting')
@click.option('--gpu', is_flag=True, 
              help='Enable GPU acceleration if available')
@click.option('--confidence', '-c', type=float, default=0.95,
              help='Confidence level for prediction intervals')
@click.option('--output', '-o', type=click.Path(),
              help='Output file for forecast results')
@click.option('--format', '-f', 
              type=click.Choice(['json', 'csv', 'text']),
              default='text',
              help='Output format')
@click.option('--plot', is_flag=True,
              help='Generate forecast plot')
def forecast(symbol: str, horizon: int, model: str, gpu: bool, 
             confidence: float, output: Optional[str], format: str, plot: bool):
    """Generate neural forecasts for a trading symbol."""
    from benchmark.src.commands.neural_command import neural as neural_commands
    
    # Create a context and invoke the neural forecast command
    ctx = click.Context(neural_commands)
    ctx.params = {
        'symbol': symbol,
        'horizon': horizon,
        'model': model,
        'gpu': gpu,
        'confidence': confidence,
        'output': output,
        'format': format,
        'plot': plot
    }
    
    # Import and run the forecast command
    try:
        from benchmark.src.commands.neural_command import neural
        forecast_cmd = None
        for cmd in neural.commands.values():
            if cmd.name == 'forecast':
                forecast_cmd = cmd
                break
        
        if forecast_cmd:
            # Only pass the expected parameters to avoid 'unexpected keyword argument' error
            expected_params = {
                'symbol': symbol,
                'horizon': horizon,
                'model': model,
                'gpu': gpu,
                'confidence': confidence,
                'output': output,
                'format': format,
                'plot': plot
            }
            ctx.params.update(expected_params)
            forecast_cmd.invoke(ctx)
        else:
            click.echo("Error: Neural forecast command not found", err=True)
    except ImportError as e:
        click.echo(f"Error: Failed to import neural commands: {e}", err=True)
        sys.exit(1)


@neural.command()
@click.argument('dataset', required=True)
@click.option('--model', '-m', 
              type=click.Choice(['nhits', 'nbeats', 'tft', 'patchtst']),
              default='nhits',
              help='Neural model to train')
@click.option('--epochs', '-e', type=int, default=100,
              help='Number of training epochs')
@click.option('--batch-size', '-b', type=int, default=32,
              help='Training batch size')
@click.option('--learning-rate', '-lr', type=float, default=0.001,
              help='Learning rate for training')
@click.option('--validation-split', '-v', type=float, default=0.2,
              help='Validation split ratio')
@click.option('--gpu', is_flag=True,
              help='Enable GPU acceleration')
@click.option('--output', '-o', type=click.Path(),
              help='Output path for trained model')
@click.option('--early-stopping', is_flag=True,
              help='Enable early stopping')
def train(dataset: str, model: str, epochs: int, batch_size: int,
          learning_rate: float, validation_split: float, gpu: bool,
          output: Optional[str], early_stopping: bool):
    """Train a neural forecasting model on custom dataset."""
    from benchmark.cli import main as benchmark_main
    
    # Construct arguments for the benchmark CLI
    sys.argv = [
        'benchmark-cli', 'neural', 'train', dataset,
        '--model', model,
        '--epochs', str(epochs),
        '--batch-size', str(batch_size),
        '--learning-rate', str(learning_rate),
        '--validation-split', str(validation_split)
    ]
    
    if gpu:
        sys.argv.append('--gpu')
    if output:
        sys.argv.extend(['--output', output])
    if early_stopping:
        sys.argv.append('--early-stopping')
    
    # Run the benchmark CLI
    try:
        benchmark_main()
    except SystemExit:
        pass


@neural.command()
@click.argument('model_path', required=True)
@click.option('--test-data', '-t', type=click.Path(exists=True),
              help='Test dataset for evaluation')
@click.option('--metrics', '-m', default='mae,mape,rmse',
              help='Evaluation metrics (comma-separated)')
@click.option('--output', '-o', type=click.Path(),
              help='Output file for evaluation results')
@click.option('--format', '-f',
              type=click.Choice(['json', 'csv', 'text']),
              default='text',
              help='Output format')
def evaluate(model_path: str, test_data: Optional[str], metrics: str,
             output: Optional[str], format: str):
    """Evaluate a trained neural forecasting model."""
    from benchmark.cli import main as benchmark_main
    
    sys.argv = [
        'benchmark-cli', 'neural', 'evaluate', model_path,
        '--metrics', metrics,
        '--format', format
    ]
    
    if test_data:
        sys.argv.extend(['--test-data', test_data])
    if output:
        sys.argv.extend(['--output', output])
    
    try:
        benchmark_main()
    except SystemExit:
        pass


@neural.command()
@click.argument('model_path', required=True)
@click.option('--symbol', '-s', required=True,
              help='Trading symbol for backtesting')
@click.option('--start', type=click.DateTime(formats=['%Y-%m-%d']), required=True,
              help='Start date for backtesting (YYYY-MM-DD)')
@click.option('--end', type=click.DateTime(formats=['%Y-%m-%d']), required=True,
              help='End date for backtesting (YYYY-MM-DD)')
@click.option('--strategy', default='buy_hold',
              help='Trading strategy to use with forecasts')
@click.option('--initial-capital', '-c', type=float, default=10000,
              help='Initial capital for backtesting')
@click.option('--output', '-o', type=click.Path(),
              help='Output file for backtest results')
@click.option('--plot', is_flag=True,
              help='Generate performance plots')
def backtest(model_path: str, symbol: str, start, end,
             strategy: str, initial_capital: float, output: Optional[str], plot: bool):
    """Run backtesting using neural forecasting model."""
    from benchmark.cli import main as benchmark_main
    
    sys.argv = [
        'benchmark-cli', 'neural', 'backtest', model_path,
        '--symbol', symbol,
        '--start', start.strftime('%Y-%m-%d'),
        '--end', end.strftime('%Y-%m-%d'),
        '--strategy', strategy,
        '--initial-capital', str(initial_capital)
    ]
    
    if output:
        sys.argv.extend(['--output', output])
    if plot:
        sys.argv.append('--plot')
    
    try:
        benchmark_main()
    except SystemExit:
        pass


@neural.command()
@click.argument('model_path', required=True)
@click.option('--env', '-e', 
              type=click.Choice(['development', 'staging', 'production']),
              default='development',
              help='Deployment environment')
@click.option('--traffic', '-t', type=int, default=100,
              help='Traffic percentage to route to new model')
@click.option('--health-check', is_flag=True,
              help='Run health checks before deployment')
@click.option('--rollback-threshold', type=float, default=0.1,
              help='Error rate threshold for automatic rollback')
def deploy(model_path: str, env: str, traffic: int, health_check: bool,
           rollback_threshold: float):
    """Deploy a neural forecasting model to production."""
    from benchmark.cli import main as benchmark_main
    
    sys.argv = [
        'benchmark-cli', 'neural', 'deploy', model_path,
        '--env', env,
        '--traffic', str(traffic),
        '--rollback-threshold', str(rollback_threshold)
    ]
    
    if health_check:
        sys.argv.append('--health-check')
    
    try:
        benchmark_main()
    except SystemExit:
        pass


@neural.command()
@click.option('--dashboard', is_flag=True,
              help='Launch monitoring dashboard')
@click.option('--env', '-e',
              type=click.Choice(['development', 'staging', 'production', 'all']),
              default='all',
              help='Environment to monitor')
@click.option('--refresh', '-r', type=int, default=30,
              help='Refresh interval in seconds')
@click.option('--alerts', is_flag=True,
              help='Enable alert notifications')
def monitor(dashboard: bool, env: str, refresh: int, alerts: bool):
    """Monitor deployed neural forecasting models."""
    from benchmark.cli import main as benchmark_main
    
    sys.argv = [
        'benchmark-cli', 'neural', 'monitor',
        '--env', env,
        '--refresh', str(refresh)
    ]
    
    if dashboard:
        sys.argv.append('--dashboard')
    if alerts:
        sys.argv.append('--alerts')
    
    try:
        benchmark_main()
    except SystemExit:
        pass


@neural.command()
@click.argument('model_path', required=True)
@click.option('--trials', '-t', type=int, default=50,
              help='Number of optimization trials')
@click.option('--metric', '-m', default='mae',
              type=click.Choice(['mae', 'mape', 'rmse', 'sharpe']),
              help='Optimization metric')
@click.option('--gpu', is_flag=True,
              help='Enable GPU acceleration for optimization')
@click.option('--output', '-o', type=click.Path(),
              help='Output file for optimized parameters')
@click.option('--timeout', type=int, default=3600,
              help='Optimization timeout in seconds')
def optimize(model_path: str, trials: int, metric: str, gpu: bool,
             output: Optional[str], timeout: int):
    """Optimize neural model hyperparameters."""
    from benchmark.cli import main as benchmark_main
    
    sys.argv = [
        'benchmark-cli', 'neural', 'optimize', model_path,
        '--trials', str(trials),
        '--metric', metric,
        '--timeout', str(timeout)
    ]
    
    if gpu:
        sys.argv.append('--gpu')
    if output:
        sys.argv.extend(['--output', output])
    
    try:
        benchmark_main()
    except SystemExit:
        pass


@cli.group()
def benchmark():
    """Performance benchmarking commands."""
    pass


@benchmark.command()
@click.option('--strategy', '-s', 
              type=click.Choice(['momentum', 'swing', 'mirror', 'all']),
              default='all',
              help='Trading strategy to benchmark')
@click.option('--duration', '-d', 
              default='1h',
              help='Duration for benchmark (e.g., 1h, 30m, 5m)')
@click.option('--assets', '-a',
              default='stocks',
              help='Asset types to benchmark (comma-separated: stocks,bonds,crypto)')
@click.option('--output', '-o',
              type=click.Path(),
              help='Output file for results')
@click.option('--format', '-f',
              type=click.Choice(['json', 'csv', 'text']),
              default='text',
              help='Output format')
@click.option('--progress', is_flag=True,
              help='Show progress bar during benchmarking')
@click.option('--concurrent', is_flag=True,
              help='Enable concurrent execution')
@click.option('--workers', '-w',
              type=int,
              default=4,
              help='Number of concurrent workers')
def run(strategy: str, duration: str, assets: str, 
        output: Optional[str], format: str, progress: bool,
        concurrent: bool, workers: int):
    """Run benchmarks on trading strategies."""
    from benchmark.cli import main as benchmark_main
    
    sys.argv = [
        'benchmark-cli', 'benchmark',
        '--strategy', strategy,
        '--duration', duration,
        '--assets', assets,
        '--format', format,
        '--workers', str(workers)
    ]
    
    if output:
        sys.argv.extend(['--output', output])
    if progress:
        sys.argv.append('--progress')
    if concurrent:
        sys.argv.append('--concurrent')
    
    try:
        benchmark_main()
    except SystemExit:
        pass


def main():
    """Main entry point for the enhanced Claude-Flow CLI."""
    try:
        cli(prog_name='claude-flow')
    except Exception as e:
        click.echo(f"Error: {str(e)}", err=True)
        sys.exit(1)


if __name__ == '__main__':
    main()