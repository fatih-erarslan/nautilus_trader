version: '3.8'

services:
  # Test npm pack + install workflow
  pack-install-test:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.npm-test
      target: pack-test
    command: >
      sh -c "
        echo '=========================================' &&
        echo 'ğŸ§ª NPM Pack + Install Test' &&
        echo '=========================================' &&
        cd /test-install &&
        npm list neural-trader &&
        node -e \"
          try {
            const nt = require('neural-trader');
            console.log('\\nâœ… SUCCESS: Package installed and loads correctly');
            console.log('Available exports:', Object.keys(nt).length);
          } catch (e) {
            console.error('\\nâŒ FAILED:', e.message);
            process.exit(1);
          }
        \"
      "

  # Test building from source
  build-source-test:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.npm-test
      target: build-from-source-test
    command: >
      sh -c "
        echo '=========================================' &&
        echo 'ğŸ”¨ Build From Source Test' &&
        echo '=========================================' &&
        node scripts/check-binaries.js &&
        echo '\nTesting module...' &&
        node -e \"
          try {
            require('./index.js');
            console.log('\\nâœ… SUCCESS: Built and loads correctly');
          } catch (e) {
            console.error('\\nâš ï¸  Warning:', e.message);
          }
        \"
      "

  # Test binary checking
  binary-check-test:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.npm-test
      target: binary-check-test
    command: >
      sh -c "
        echo '=========================================' &&
        echo 'ğŸ” Binary Check Test' &&
        echo '=========================================' &&
        node scripts/check-binaries.js
      "

  # Test dependency installation
  dependency-test:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.npm-test
      target: dependency-test

networks:
  default:
    name: neural-trader-test
