#!/bin/bash
# Real-Time Trading System Command for Claude Code
# Manages the news-driven trading system as a background process

set -e

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PYTHON_SCRIPT="$SCRIPT_DIR/scripts/start_real_time_trading.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if Python script exists
if [ ! -f "$PYTHON_SCRIPT" ]; then
    log_error "Python script not found: $PYTHON_SCRIPT"
    exit 1
fi

# Check if required environment variables are set
check_env() {
    if [ -z "$ALPACA_API_KEY" ] || [ -z "$ALPACA_API_SECRET" ]; then
        log_warning "Alpaca credentials not found in environment"
        log_info "Checking .env file..."
        if [ -f "$SCRIPT_DIR/.env" ]; then
            log_info "Loading credentials from .env file"
        else
            log_error "No .env file found. Please set ALPACA_API_KEY and ALPACA_API_SECRET"
            exit 1
        fi
    fi
}

# Start trading system as background process
start_trading() {
    log_info "Starting Real-Time Trading System..."
    check_env
    
    # Parse additional arguments
    args=("$@")
    
    # Check if we're in Claude Code environment
    if [ -n "$CLAUDE_CODE_SESSION" ] || [ -n "$ANTHROPIC_CLI" ]; then
        log_info "Detected Claude Code environment - using native background process..."
        log_info "Command will be executed as: python \"$PYTHON_SCRIPT\" start ${args[*]}"
        log_info "Use BashOutput tool to monitor progress"
        
        # Execute via Claude Code's background system
        exec python "$PYTHON_SCRIPT" start "${args[@]}"
    else
        # Run in background with nohup for persistence
        log_info "Launching trading system in background..."
        nohup python "$PYTHON_SCRIPT" start "${args[@]}" > trading_system.log 2>&1 &
        
        local pid=$!
        echo $pid > trading_system.pid
        
        log_success "Trading system started with PID: $pid"
        log_info "Log file: trading_system.log"
        log_info "PID file: trading_system.pid"
        
        # Wait a moment and check if process is still running
        sleep 2
        if kill -0 $pid 2>/dev/null; then
            log_success "System is running successfully"
            log_info "Use './start-real-time-trading status' to monitor"
        else
            log_error "System failed to start. Check trading_system.log"
            exit 1
        fi
    fi
}

# Stop trading system
stop_trading() {
    log_info "Stopping Real-Time Trading System..."
    
    if [ -f trading_system.pid ]; then
        local pid=$(cat trading_system.pid)
        if kill -0 $pid 2>/dev/null; then
            log_info "Terminating process $pid..."
            kill $pid
            
            # Wait for graceful shutdown
            local count=0
            while kill -0 $pid 2>/dev/null && [ $count -lt 10 ]; do
                sleep 1
                count=$((count + 1))
            done
            
            # Force kill if still running
            if kill -0 $pid 2>/dev/null; then
                log_warning "Force killing process..."
                kill -9 $pid
            fi
            
            rm -f trading_system.pid
            log_success "Trading system stopped"
        else
            log_warning "Process $pid not found"
            rm -f trading_system.pid
        fi
    else
        log_warning "No PID file found. System may not be running."
    fi
}

# Check system status
check_status() {
    log_info "Checking Real-Time Trading System Status..."
    
    if [ -f trading_system.pid ]; then
        local pid=$(cat trading_system.pid)
        if kill -0 $pid 2>/dev/null; then
            log_success "System is running (PID: $pid)"
            
            # Show process info
            if command -v ps > /dev/null; then
                log_info "Process details:"
                ps -p $pid -o pid,ppid,pcpu,pmem,etime,cmd 2>/dev/null || true
            fi
            
            # Show status from Python script if available
            if [ -f trader_status.json ]; then
                log_info "System status:"
                cat trader_status.json | python -m json.tool 2>/dev/null || cat trader_status.json
            fi
            
            return 0
        else
            log_warning "PID file exists but process $pid not running"
            rm -f trading_system.pid
            return 1
        fi
    else
        log_info "System is not running"
        return 1
    fi
}

# Show recent logs
show_logs() {
    local lines=${1:-50}
    log_info "Showing last $lines lines from trading system log..."
    
    if [ -f trading_system.log ]; then
        tail -n "$lines" trading_system.log
    elif [ -f logs/trader_*.log ]; then
        # Find most recent log file
        local latest_log=$(ls -t logs/trader_*.log 2>/dev/null | head -1)
        if [ -n "$latest_log" ]; then
            log_info "Reading from: $latest_log"
            tail -n "$lines" "$latest_log"
        fi
    else
        log_warning "No log files found"
    fi
}

# Restart system
restart_trading() {
    log_info "Restarting Real-Time Trading System..."
    stop_trading
    sleep 2
    start_trading "$@"
}

# Demo mode
run_demo() {
    local duration=${1:-3}
    log_info "Running Real-Time Trading Demo (${duration} minutes)..."
    check_env
    
    local demo_script="$SCRIPT_DIR/scripts/demo_real_time_trading.py"
    if [ -f "$demo_script" ]; then
        python "$demo_script" --duration "$duration"
    else
        log_error "Demo script not found: $demo_script"
        exit 1
    fi
}

# Main command processing
case "${1:-help}" in
    "start")
        shift
        start_trading "$@"
        ;;
    "stop")
        stop_trading
        ;;
    "restart") 
        shift
        restart_trading "$@"
        ;;
    "status")
        check_status
        ;;
    "logs")
        show_logs "${2:-50}"
        ;;
    "demo")
        run_demo "${2:-3}"
        ;;
    "help"|"-h"|"--help")
        echo "Real-Time News-Driven Trading System"
        echo
        echo "Usage: $0 COMMAND [OPTIONS]"
        echo
        echo "Commands:"
        echo "  start [--symbols SYM1 SYM2] [--max-position AMOUNT]"
        echo "        Start trading system in background"
        echo "  stop    Stop the trading system"
        echo "  restart Restart the trading system"  
        echo "  status  Check if system is running"
        echo "  logs [N] Show last N log lines (default: 50)"
        echo "  demo [MINUTES] Run safe demo (default: 3 minutes)"
        echo "  help    Show this help message"
        echo
        echo "Examples:"
        echo "  $0 start"
        echo "  $0 start --symbols SPY AAPL --max-position 500"
        echo "  $0 status"
        echo "  $0 logs 100"
        echo "  $0 demo 5"
        echo "  $0 stop"
        echo
        echo "Environment:"
        echo "  ALPACA_API_KEY     - Required: Your Alpaca API key"
        echo "  ALPACA_API_SECRET  - Required: Your Alpaca API secret"
        echo "  ALPACA_API_ENDPOINT- Optional: API endpoint (defaults to paper)"
        echo
        ;;
    *)
        log_error "Unknown command: $1"
        log_info "Use '$0 help' for available commands"
        exit 1
        ;;
esac