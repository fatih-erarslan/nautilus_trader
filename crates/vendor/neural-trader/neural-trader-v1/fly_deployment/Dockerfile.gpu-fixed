# Fixed GPU Dockerfile for Fly.io with TA-Lib support
FROM pytorch/pytorch:2.1.0-cuda12.1-cudnn8-devel

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Set CUDA environment
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# Install system dependencies including TA-Lib
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    build-essential \
    libta-lib0-dev \
    ta-lib-bin \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements files
COPY requirements.txt /app/requirements.txt

# Install core Python dependencies first
RUN pip install --no-cache-dir -r requirements.txt

# Install PyTorch with CUDA support (ensure latest)
RUN pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# Install TA-Lib Python wrapper (now that system lib is installed)
RUN pip install --no-cache-dir TA-Lib>=0.4.24

# Install neural forecasting with GPU support
RUN pip install --no-cache-dir 'neuralforecast[gpu]>=1.6.4'

# Install additional neural forecasting libraries
RUN pip install --no-cache-dir \
    pytorch-lightning>=2.0.0 \
    statsforecast>=1.6.0 \
    hierarchicalforecast>=0.3.0

# Install GPU monitoring libraries
RUN pip install --no-cache-dir \
    nvidia-ml-py \
    pynvml \
    GPUtil \
    py3nvml

# Install MCP dependencies (without TA-Lib conflict)
RUN pip install --no-cache-dir \
    'mcp[cli]>=1.9.4' \
    'fastmcp>=2.9.0' \
    pytest>=7.0.0 \
    pytest-asyncio>=0.21.0

# Copy application code
COPY . /app/

# Set up environment variables
ENV PYTHONPATH=/app
ENV NEURAL_FORECAST_GPU_ENABLED=true
ENV NEURAL_FORECAST_MODEL_TYPE=nhits
ENV FLYIO_GPU_DEPLOYMENT=true

# NVIDIA Container Runtime environment
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# PyTorch CUDA optimization
ENV PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512,garbage_collection_threshold:0.6

# TensorRT optimization
ENV TRT_LOGGER_VERBOSITY=WARNING
ENV TENSORRT_VERBOSE=0

# Performance optimization
ENV OMP_NUM_THREADS=8
ENV MKL_NUM_THREADS=8

# Create necessary directories
RUN mkdir -p /app/logs /app/models /app/data /app/cache

# Create non-root user
RUN useradd -m -u 1000 trader && \
    chown -R trader:trader /app
USER trader

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# GPU-enabled startup
CMD ["python", "src/neural_forecast/flyio_gpu_launcher.py"]