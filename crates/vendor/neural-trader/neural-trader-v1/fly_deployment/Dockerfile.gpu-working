# Working GPU Dockerfile for Fly.io
FROM pytorch/pytorch:2.1.0-cuda12.1-cudnn8-devel

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Set CUDA environment
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install Python dependencies
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Install PyTorch with CUDA support (already in base image but ensure latest)
RUN pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# Install neural forecasting with GPU support
RUN pip install --no-cache-dir 'neuralforecast[gpu]>=1.6.4'

# Install additional GPU libraries
RUN pip install --no-cache-dir \
    nvidia-ml-py \
    pynvml \
    GPUtil

# Copy application code
COPY . /app/

# Set up environment variables
ENV PYTHONPATH=/app
ENV NEURAL_FORECAST_GPU_ENABLED=true
ENV NEURAL_FORECAST_MODEL_TYPE=nhits
ENV FLYIO_GPU_DEPLOYMENT=true

# NVIDIA Container Runtime environment
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# PyTorch CUDA optimization
ENV PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512,garbage_collection_threshold:0.6

# Create necessary directories
RUN mkdir -p /app/logs /app/models /app/data /app/cache

# Create non-root user
RUN useradd -m -u 1000 trader && \
    chown -R trader:trader /app
USER trader

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# GPU-enabled startup
CMD ["python", "src/neural_forecast/flyio_gpu_launcher.py"]