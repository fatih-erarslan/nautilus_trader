#!/bin/bash
# Neural Trader Rust Port - Comprehensive Validation Script

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
REPORT_FILE="$PROJECT_ROOT/docs/VALIDATION_REPORT_$(date +%Y%m%d_%H%M%S).md"

echo "=================================================="
echo "Neural Trader Rust Port - Validation Suite"
echo "=================================================="
echo ""
echo "Project: $PROJECT_ROOT"
echo "Report: $REPORT_FILE"
echo ""

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if compilation succeeds
echo "Step 1: Checking compilation..."
if cargo build --release --all-features 2>&1 | tee /tmp/build.log; then
    echo -e "${GREEN}✓ Compilation successful${NC}"
else
    echo -e "${RED}✗ Compilation failed${NC}"
    echo "Please fix compilation errors before running validation."
    echo "See /tmp/build.log for details"
    exit 1
fi
echo ""

# Run unit tests
echo "Step 2: Running unit tests..."
if cargo test --lib --all-features 2>&1 | tee /tmp/unit_tests.log; then
    UNIT_PASSED=$(grep -c "test result: ok" /tmp/unit_tests.log || echo "0")
    echo -e "${GREEN}✓ Unit tests passed${NC}"
else
    echo -e "${YELLOW}⚠ Some unit tests failed${NC}"
    UNIT_PASSED=0
fi
echo ""

# Run integration tests
echo "Step 3: Running integration tests..."
if cargo test --test '*' --all-features 2>&1 | tee /tmp/integration_tests.log; then
    INTEGRATION_PASSED=$(grep -c "test result: ok" /tmp/integration_tests.log || echo "0")
    echo -e "${GREEN}✓ Integration tests passed${NC}"
else
    echo -e "${YELLOW}⚠ Some integration tests failed${NC}"
    INTEGRATION_PASSED=0
fi
echo ""

# Run benchmarks
echo "Step 4: Running performance benchmarks..."
if cargo bench --all-features 2>&1 | tee /tmp/benchmarks.log; then
    echo -e "${GREEN}✓ Benchmarks completed${NC}"
else
    echo -e "${YELLOW}⚠ Some benchmarks failed${NC}"
fi
echo ""

# Generate coverage report
echo "Step 5: Generating coverage report..."
if command -v cargo-tarpaulin &> /dev/null; then
    cargo tarpaulin --all --all-features --out Html --output-dir coverage 2>&1 | tee /tmp/coverage.log
    COVERAGE=$(grep -oP 'coverage: \K[0-9.]+' /tmp/coverage.log | tail -1 || echo "0")
    echo -e "${GREEN}✓ Coverage report generated: ${COVERAGE}%${NC}"
else
    echo -e "${YELLOW}⚠ cargo-tarpaulin not installed, skipping coverage${NC}"
    COVERAGE="N/A"
fi
echo ""

# Check warnings
echo "Step 6: Checking for warnings..."
WARNINGS=$(grep -c "warning:" /tmp/build.log || echo "0")
if [ "$WARNINGS" -eq 0 ]; then
    echo -e "${GREEN}✓ No warnings${NC}"
else
    echo -e "${YELLOW}⚠ Found $WARNINGS warnings${NC}"
fi
echo ""

# Generate validation report
echo "Step 7: Generating validation report..."
cat > "$REPORT_FILE" << EOF
# Neural Trader Rust Port - Validation Report

**Generated:** $(date +"%Y-%m-%d %H:%M:%S")
**Status:** $([ "$UNIT_PASSED" -gt 0 ] && echo "✅ PASSED" || echo "⚠️ NEEDS ATTENTION")

## Executive Summary

### Compilation
- Status: ✅ SUCCESS
- Warnings: $WARNINGS

### Testing
- Unit Tests: $UNIT_PASSED suites passed
- Integration Tests: $INTEGRATION_PASSED suites passed
- Coverage: $COVERAGE%

### Performance
- Benchmarks: See /tmp/benchmarks.log

## Detailed Results

### Unit Test Results
\`\`\`
$(tail -20 /tmp/unit_tests.log)
\`\`\`

### Integration Test Results
\`\`\`
$(tail -20 /tmp/integration_tests.log)
\`\`\`

### Build Warnings
\`\`\`
$(grep "warning:" /tmp/build.log | head -20)
\`\`\`

## Performance Benchmarks

See full benchmark results in /tmp/benchmarks.log

## Recommendations

$(if [ "$WARNINGS" -gt 0 ]; then
    echo "1. Fix $WARNINGS compiler warnings"
fi)
$(if [ "$COVERAGE" != "N/A" ] && [ "${COVERAGE%.*}" -lt 90 ]; then
    echo "2. Improve test coverage (current: $COVERAGE%, target: >90%)"
fi)

## Next Steps

1. Review failed tests (if any)
2. Address compiler warnings
3. Improve test coverage
4. Run production readiness checks

---

**Report Generated By:** run_validation.sh
**Full Logs:**
- Build: /tmp/build.log
- Unit Tests: /tmp/unit_tests.log
- Integration Tests: /tmp/integration_tests.log
- Benchmarks: /tmp/benchmarks.log
- Coverage: coverage/index.html
EOF

echo -e "${GREEN}✓ Validation report generated: $REPORT_FILE${NC}"
echo ""

# Summary
echo "=================================================="
echo "Validation Complete"
echo "=================================================="
echo "Compilation: SUCCESS"
echo "Unit Tests: $UNIT_PASSED suites"
echo "Integration Tests: $INTEGRATION_PASSED suites"
echo "Coverage: $COVERAGE%"
echo "Warnings: $WARNINGS"
echo ""
echo "Full report: $REPORT_FILE"
echo "Coverage: coverage/index.html"
echo "=================================================="
